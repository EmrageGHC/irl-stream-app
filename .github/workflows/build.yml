name: Build APK

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Check network connectivity
      run: |
        echo "Testing network..."
        ping -c 4 8.8.8.8
        curl -I https://www.google.com
    
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y openjdk-17-jdk zip unzip wget autoconf automake libtool pkg-config
    
    - name: Install Buildozer
      run: |
        pip install --upgrade pip
        pip install buildozer==1.5.0 cython==0.29.36
    
    - name: Build APK with retries
      run: |
        set -euo pipefail
        MAX_ATTEMPTS=3
        RETRY_WAIT_SECONDS=30
        CMD='yes | buildozer android debug'

        attempt=1
        while [ $attempt -le $MAX_ATTEMPTS ]; do
          echo "=== Build attempt $attempt/$MAX_ATTEMPTS ==="
          if bash -c "$CMD"; then
            echo "✅ Build succeeded on attempt $attempt"
            exit 0
          fi
          echo "❌ Build failed on attempt $attempt"
          if [ $attempt -lt $MAX_ATTEMPTS ]; then
            sleep_seconds=$((RETRY_WAIT_SECONDS * attempt))
            echo "⏱️  Waiting ${sleep_seconds}s before next attempt..."
            sleep "$sleep_seconds"
          fi
          attempt=$((attempt + 1))
        done

        echo "❌ ERROR: All $MAX_ATTEMPTS build attempts failed"
        exit 1
    
    - name: Upload APK Artifact
      uses: actions/upload-artifact@v4
      with:
        name: irl-stream-app
        path: bin/*.apk
        retention-days: 30
